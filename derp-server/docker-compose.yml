# docker-compose.yml（所有节点通用）
# version: '3.8'

services:
  derper:
    build: .
    container_name: derper
    restart: unless-stopped
    ports:
      - "3478:3478/udp"
      - "443:443/tcp"
    environment:
      - DERP_HOST=derp-aly.grep2000.com
      - DERP_CERT_MODE=manual
      - DERP_CERT_DIR=/app/certs
      - DERP_DOMAIN=derp-aly.grep2000.com  # ⭐ 必须设置
      - DERP_CERT_MODE=letsencrypt   # 或手动证书
    volumes:
      - ./certs:/app/certs
    entrypoint: ["sh", "-c", "rm -rf /var/lib/derper && exec derper"]
    command: >
      --hostname=derp-aly.grep2000.com 
      --certmode=manual 
      --certdir=/app/certs 
      --stun 
      -a :443 
      --stun-port=3478 
      --verify-clients=false 
      --mesh-psk-file=/dev/null  # 明确指定
    env_file:
      - .env                                          # ← 每台服务器只改这一个文件
